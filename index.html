<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Monitoreo Inventarios por Usuario</title>

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    :root{
      --azul:#00416A;
      --prim:#0c6cbd;
      --blanco:#fff;
      --sombra:rgba(0,0,0,.15);

      /* Ajustes rápidos marca de agua */
      --wm-size: min(70vmin, 900px);   /* tamaño máximo */
      --wm-opacity: .08;               /* transparencia */
      --wm-rotate: -8deg;              /* inclinación */
    }

    *{ box-sizing:border-box }
    html,body{ height:100% }
    body{
      margin:0;
      min-height:100%;
      display:flex; flex-direction:column;
      font-family:'Poppins',sans-serif;
      color:white;
      background:linear-gradient(to right,#00416A,#E4E5E6);
    }

    main{ position:relative; z-index:1; padding:20px; flex:1 0 auto }
    h1{ margin:0 0 16px; text-align:center }

    .barra{
      display:flex; gap:10px; flex-wrap:wrap;
      justify-content:center; align-items:center; margin-bottom:12px;
    }
    select,button{
      border:none; border-radius:10px; padding:10px 14px;
      font-size:16px; font-family:inherit;
    }
    select{ background:white; color:#111; min-width:240px }
    .btn{ background:var(--prim); color:white; font-weight:600; cursor:pointer; box-shadow:0 4px 12px var(--sombra) }
    .btn[disabled]{ opacity:.6; cursor:not-allowed }
    .btn:hover{ filter:brightness(.95) }

    #estado{ text-align:center; margin:6px auto 12px; min-height:22px }
    .ok{ background:rgba(255,255,255,.15); border:1px solid rgba(255,255,255,.25); display:inline-block; padding:4px 10px; border-radius:999px }
    .err{ background:#b00020; color:#fff; display:inline-block; padding:4px 10px; border-radius:8px }

    .contenedor{ max-width:1100px; margin:0 auto }
    .grid{
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(260px,1fr));
      gap:14px;
    }
    .card{
      background:rgba(255,255,255,.15);
      border:1px solid rgba(255,255,255,.25);
      border-radius:14px;
      padding:14px; color:white;
      box-shadow:0 6px 18px var(--sombra);
      display:flex; flex-direction:column; gap:8px;
    }
    .titulo{ font-weight:700; font-size:18px; line-height:1.2 }
    .pill{ display:inline-block; background:white; color:#0c6cbd; border:1px solid #0c6cbd; padding:3px 8px; border-radius:999px; font-size:12px; font-weight:700 }
    .fila{ display:flex; gap:8px; align-items:center; justify-content:space-between; flex-wrap:wrap }
    .muted{ opacity:.9 }
    .right{ display:flex; gap:8px; align-items:center; flex-wrap:wrap }

    /* ===== Marca de agua con logo (como en tu panel) ===== */
    .wm-logo{
      position:fixed; inset:0; pointer-events:none; z-index:0;
      display:flex; align-items:center; justify-content:center;
    }
    .wm-logo::before{
      content:"";
      width:var(--wm-size); height:var(--wm-size);
      background-image:url('logo-proveedora.webp'); /* <-- cambia ruta si es necesario */
      background-repeat:no-repeat;
      background-position:center center;
      background-size:contain;
      opacity:var(--wm-opacity);
      transform:rotate(var(--wm-rotate));
      filter:sepia(1) saturate(12) hue-rotate(-6deg) brightness(0.95); /* leve tinte rojizo como en la captura */
      mix-blend-mode:multiply;
    }

    /* ===== Footer fijo ===== */
    footer{
      flex-shrink:0;
      position:relative; z-index:1;
      padding:12px 16px; text-align:center; color:#fff;
      background:linear-gradient(90deg, rgba(0,0,0,.18), rgba(255,255,255,.12));
      border-top:1px solid rgba(255,255,255,.2);
      backdrop-filter: blur(4px);
      font-weight:600;
      letter-spacing:.3px;
    }
    footer span{ opacity:.9 }
  </style>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collectionGroup, getDocs, query, orderBy } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // ==== Config Firebase ====
    const firebaseConfig = {
      apiKey: "AIzaSyCK5nb6u2CGRJ8AB1aPlRn54b97bdeAFeM",
      authDomain: "inventariopv-643f1.firebaseapp.com",
      projectId: "inventariopv-643f1",
      storageBucket: "inventariopv-643f1.appspot.com",
      messagingSenderId: "96242533231",
      appId: "1:96242533231:web:aae75a18fbaf9840529e9a"
    };
    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    // ==== Utils ====
    const roundTo = (n,d)=> Math.round((Number(n)||0)*10**d)/10**d;
    const fmt = (n,d)=> Number(n||0).toFixed(d);
    const cap = s => String(s||'').charAt(0).toUpperCase() + String(s||'').slice(1);
    const toIso = v => { try{ if(v?.toDate) return v.toDate().toISOString(); }catch{} return typeof v==='string'?v:null; };

    // ==== DOM ====
    const selUsuario    = document.getElementById('sel-usuario');
    const btnBuscar     = document.getElementById('btn-buscar');
    const btnConcentrar = document.getElementById('btn-concentrar');
    const estado        = document.getElementById('estado');
    const grid          = document.getElementById('grid');

    // Estado
    let inventarios = [];

    render([]); // arranque vacío

    selUsuario.addEventListener('change', ()=> render(filter()));
    btnBuscar.addEventListener('click', buscar);
    btnConcentrar.addEventListener('click', ()=>{
      const lista = filter();
      if(!lista.length){ alert('No hay inventarios para concentrar.'); return; }
      const items = concentrar(lista);
      const etiqueta = selUsuario.value==='todos' ? 'Todos' : cap(selUsuario.value);
      descargarExcelConcentrado(items, etiqueta);
    });

    async function buscar(){
      try{
        setEstado('Buscando…');
        const q1 = query(collectionGroup(db,'escaneos'), orderBy('fecha','desc'));
        inventarios = await fetchDocs(q1);
        setEstado(`Listo: ${inventarios.length} inventario(s).`, 'ok');
      }catch(e){
        console.warn('Fallo orderBy(fecha). Reintentando sin índice…', e);
        try{
          const q2 = query(collectionGroup(db,'escaneos'));
          inventarios = await fetchDocs(q2);
          inventarios.sort((a,b)=> (b.fechaIso||'').localeCompare(a.fechaIso||'')); // ordenar en cliente
          setEstado(`Listo (sin índice): ${inventarios.length} inventario(s).`, 'ok');
        }catch(err){
          console.error(err);
          setEstado('Error leyendo Firestore. Revisa permisos/índices.', 'err');
          inventarios = [];
        }
      }
      render(filter());
    }

    async function fetchDocs(qry){
      const snap = await getDocs(qry);
      const out = [];
      snap.forEach(doc=>{
        const partes  = doc.ref.path.split('/');  // inventarios/<usuario>/escaneos/<id>
        const usuario = (partes.length>=2 ? partes[1] : (doc.data().usuario || 'desconocido')).toLowerCase();
        const d = doc.data();
        out.push({
          usuario,
          folio: d.folio || '(sin folio)',
          fechaIso: toIso(d.fecha),
          articulos: d.articulos || []
        });
      });
      return out;
    }

    function filter(){
      const f = selUsuario.value; // 'todos' o usuario
      return inventarios.filter(inv => f==='todos' ? true : inv.usuario===f);
    }

    function render(lista){
      const l = Array.isArray(lista)?lista:[];
      grid.innerHTML = '';
      if(!l.length){
        grid.innerHTML = `<p style="text-align:center">No hay inventarios para este filtro.</p>`;
        return;
      }
      for(const inv of l){
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
          <div class="titulo">${cap(inv.usuario)}</div>
          <div class="muted">Folio: <span class="pill">${inv.folio}</span></div>
          <div class="fila">
            <div class="muted">${inv.fechaIso ? inv.fechaIso.slice(0,16).replace('T',' ') : ''}</div>
            <div class="right"><button class="btn" data-f="${encodeURIComponent(inv.folio)}">⬇️ Excel</button></div>
          </div>
        `;
        card.querySelector('button').addEventListener('click', ()=> descargarExcelArticulos(inv.articulos, inv.folio));
        grid.appendChild(card);
      }
    }

    function setEstado(msg, kind){
      estado.className = kind==='ok' ? 'ok' : (kind==='err' ? 'err' : '');
      estado.textContent = msg || '';
    }

    // ===== Concentrado =====
    function concentrar(lista){
      const map = new Map(); // codigo => {codigo, descripcion, cantidad, precio}
      for(const inv of lista){
        for(const p of (inv.articulos||[])){
          const cod = String(p.codigo||'').trim();
          if(!cod) continue;
          const prev = map.get(cod) || { codigo: cod, descripcion: p.descripcion||'', cantidad: 0, precio: Number(p.precio||0) };
          prev.cantidad = Number(prev.cantidad||0) + Number(p.cantidad||0);
          if((p.descripcion||'').trim()) prev.descripcion = p.descripcion.trim();
          if(!isNaN(Number(p.precio))) prev.precio = Number(p.precio);
          map.set(cod, prev);
        }
      }
      return Array.from(map.values()).map(r=>({ ...r, total: roundTo(Number(r.cantidad||0)*Number(r.precio||0),2) }));
    }

    // ===== Excel: individual =====
    function descargarExcelArticulos(articulos, folio){
      const headers = [["#", "Descripción", "Código", "Cantidad", "Precio", "Total (Cant*Precio)", "Fecha", "Folio"]];
      const rows = (articulos||[]).map((p,i)=>{
        const cant = Number(p.cantidad||0);
        thePrecio: {
        }
      });
    }
  </script>
</head>
<body>
  <!-- Marca de agua con logo (como tu panel) -->
  <div class="wm-logo"></div>

  <main>
    <h1>Monitoreo Inventarios por Usuario</h1>

    <div class="barra">
      <select id="sel-usuario" title="Filtrar por usuario">
        <option value="todos">— Todos —</option>
        <option value="blanca">Blanca</option>
        <option value="lizandro">Lizandro</option>
        <option value="edgardo">Edgardo</option>
        <option value="fernanda">Fernanda</option>
        <option value="vansessa">Vansessa</option>
        <option value="esmeralda">Esmeralda</option>
        <option value="gibran">Gibran</option>
        <option value="roberto">Roberto</option>
        <option value="usuario1">Usuario 1</option>
        <option value="usuario2">Usuario 2</option>
        <option value="usuario3">Usuario 3</option>
        <option value="usuario4">Usuario 4</option>
        <option value="usuario5">Usuario 5</option>
      </select>

      <button id="btn-buscar" class="btn">🔎 Buscar</button>
      <button id="btn-concentrar" class="btn">📊 Concentrar y descargar</button>
    </div>

    <div id="estado"></div>
    <div id="grid" class="contenedor grid"></div>
  </main>

  <footer>
    <span>Desarrollado por Lizandro Sustaita</span>
  </footer>

  <script type="module">
    // (Coloqué el JS de exportes aquí para que el bloque de arriba no quede muy largo)
    import { roundTo as _r } from 'https://cdn.jsdelivr.net/gh/umaranis/utils@main/num.js'; // fallback ligero si falla arriba (opcional)

    function round2(n){ try{return Number(n||0).toFixed(2)}catch{return (Math.round((+n||0)*100)/100).toFixed(2)} }
    function round3(n){ try{return Number(n||0).toFixed(3)}catch{return (Math.round((+n||0)*1000)/1000).toFixed(3)} }

    // Busca las funciones definidas en el primer <script type="module">:
    const win = window;
    function descargarExcelArticulos(articulos, folio){
      const headers = [["#", "Descripción", "Código", "Cantidad", "Precio", "Total (Cant*Precio)", "Fecha", "Folio"]];
      const rows = (articulos||[]).map((p,i)=>{
        const cant = Number(p.cantidad||0);
        const precio = Number(p.precio||0);
        const tot = Math.round(cant*precio*100)/100;
        const ts = (p.timestamp||'').slice(0,19).replace('T',' ');
        return [i+1, p.descripcion||'', p.codigo||'', round3(cant), round2(precio), round2(tot), ts, folio];
      });
      const suma = (articulos||[]).reduce((a,b)=> a + (Number(b.cantidad||0)*Number(b.precio||0)), 0);
      rows.push([]); rows.push(["", "TOTAL INVENTARIO", "", "", "", round2(suma), "", folio]);

      const wb = XLSX.utils.book_new(); const ws = XLSX.utils.aoa_to_sheet(headers.concat(rows));
      XLSX.utils.book_append_sheet(wb, ws, "Inventario");
      XLSX.writeFile(wb, `Inventario_${folio}.xlsx`);
    }
    function descargarExcelConcentrado(items, etiqueta){
      items.sort((a,b)=> String(a.descripcion||'').localeCompare(b.descripcion||'','es'));
      const headers = [["#", "Código", "Descripción", "Cantidad", "Precio", "Total (Cant*Precio)"]];
      const rows = items.map((r,i)=>[i+1, r.codigo, r.descripcion, round3(r.cantidad), round2(r.precio), round2(r.total)]);
      const gTotal = items.reduce((a,b)=> a + Number(b.total||0), 0);
      rows.push([]); rows.push(["", "", "TOTAL GENERAL", "", "", round2(gTotal)]);
      const wb = XLSX.utils.book_new(); const ws = XLSX.utils.aoa_to_sheet(headers.concat(rows));
      XLSX.utils.book_append_sheet(wb, ws, "Concentrado");
      XLSX.writeFile(wb, `Concentrado_${etiqueta}.xlsx`);
    }

    // Exponer para que los botones del módulo principal puedan llamarlas
    window.descargarExcelArticulos = descargarExcelArticulos;
    window.descargarExcelConcentrado = descargarExcelConcentrado;
  </script>
</body>
</html>
