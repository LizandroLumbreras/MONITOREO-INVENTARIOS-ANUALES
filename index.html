<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Monitoreo Inventarios por Usuario</title>

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    :root{
      --azul:#00416A;
      --prim:#0c6cbd;
      --sombra:rgba(0,0,0,.18);

      /* ===== Marca de agua (ajusta a tu gusto) ===== */
      --wm-size: clamp(680px, 85vmin, 1500px); /* M√ÅS GRANDE */
      --wm-opacity: .16;                       /* un poquito m√°s visible */
      --wm-rotate: 0deg;                       /* 0 = derecha (sin inclinaci√≥n) */
      --wm-blend: normal;                      /* normal | multiply | screen */
    }

    *{ box-sizing:border-box }
    html, body { height:100% }
    body{
      margin:0;
      min-height:100%;
      display:flex; flex-direction:column;
      font-family:'Poppins',sans-serif;
      color:white;
      background:linear-gradient(to right,#00416A,#E4E5E6);
    }

    main{ position:relative; z-index:1; padding:20px; flex:1 0 auto }
    h1{ margin:0 0 16px; text-align:center }

    .barra{
      display:flex; gap:10px; flex-wrap:wrap;
      justify-content:center; align-items:center; margin-bottom:12px;
    }
    select,button{
      border:none; border-radius:12px; padding:10px 16px;
      font-size:16px; font-family:inherit;
    }
    select{ background:white; color:#111; min-width:240px }
    .btn{
      background:var(--prim); color:white; font-weight:700; cursor:pointer;
      box-shadow:0 6px 16px var(--sombra);
      border:1px solid rgba(255,255,255,.18);
    }
    .btn:hover{ filter:brightness(.95) }
    .btn[disabled]{ opacity:.6; cursor:not-allowed }

    #estado{ text-align:center; margin:6px auto 12px; min-height:22px }
    .ok{ background:rgba(255,255,255,.15); border:1px solid rgba(255,255,255,.25); display:inline-block; padding:4px 10px; border-radius:999px }
    .err{ background:#b00020; color:#fff; display:inline-block; padding:4px 10px; border-radius:8px }

    .contenedor{ max-width:1100px; margin:0 auto }
    .grid{
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(260px,1fr));
      gap:16px;
    }
    .card{
      background:linear-gradient(145deg, rgba(255,255,255,.14), rgba(255,255,255,.08));
      border:1px solid rgba(255,255,255,.28);
      border-radius:18px;
      padding:16px; color:white;
      box-shadow:0 8px 24px var(--sombra);
      display:flex; flex-direction:column; gap:10px;
      backdrop-filter: blur(2px);
    }
    .titulo{ font-weight:800; font-size:18px; line-height:1.2 }
    .pill{
      display:inline-block; background:white; color:#0c6cbd;
      border:1px solid #0c6cbd; padding:4px 10px; border-radius:999px;
      font-size:12px; font-weight:800
    }
    .fila{ display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap }
    .muted{ opacity:.9 }
    .right{ display:flex; gap:10px; align-items:center; flex-wrap:wrap }

    /* ===== Marca de agua (IMG) centrada ===== */
    .wm-logo{
      position:fixed; inset:0; z-index:0; pointer-events:none;
    }
    .wm-logo img{
      position:absolute;
      top:50%; left:50%;
      transform: translate(-50%, -50%) rotate(var(--wm-rotate));
      transform-origin: center center;
      width: var(--wm-size);
      height: auto;
      opacity: var(--wm-opacity);
      mix-blend-mode: var(--wm-blend);
      filter: grayscale(20%) saturate(120%) contrast(105%);
      visibility: hidden;    /* oculto hasta que realmente cargue */
    }
    .wm-logo img.show{ visibility: visible; }

    /* Asegura que el contenido quede encima */
    main { position:relative; z-index:1; }
    @media print { .wm-logo{ display:none } }

    /* ===== Footer ===== */
    footer{
      flex-shrink:0;
      position:relative; z-index:1;
      padding:12px 16px; text-align:center; color:#fff;
      background:linear-gradient(90deg, rgba(0,0,0,.18), rgba(255,255,255,.12));
      border-top:1px solid rgba(255,255,255,.2);
      backdrop-filter: blur(4px);
      font-weight:700;
      letter-spacing:.3px;
    }
    footer span{ opacity:.95 }
  </style>
</head>
<body>

  <!-- MARCA DE AGUA -->
  <div class="wm-logo">
    <!-- Alt vac√≠o para que no se vea texto si falla -->
    <img id="wm-img" alt="" aria-label="Marca de agua La Proveedora">
  </div>

  <main>
    <h1>Monitoreo Inventarios por Usuario</h1>

    <div class="barra">
      <select id="sel-usuario" title="Filtrar por usuario">
        <option value="todos">‚Äî Todos ‚Äî</option>
        <option value="blanca">Blanca</option>
        <option value="lizandro">Lizandro</option>
        <option value="edgardo">Edgardo</option>
        <option value="fernanda">Fernanda</option>
        <option value="vansessa">Vansessa</option>
        <option value="esmeralda">Esmeralda</option>
        <option value="gibran">Gibran</option>
        <option value="roberto">Roberto</option>
        <option value="usuario1">Usuario 1</option>
        <option value="usuario2">Usuario 2</option>
        <option value="usuario3">Usuario 3</option>
        <option value="usuario4">Usuario 4</option>
        <option value="usuario5">Usuario 5</option>
      </select>

      <button id="btn-buscar" class="btn">üîé Buscar</button>
      <button id="btn-concentrar" class="btn">üìä Concentrar y descargar</button>
    </div>

    <div id="estado"></div>
    <div id="grid" class="contenedor grid"></div>
  </main>

  <footer>
    ¬© 2025 <span>Panel de Herramientas La Proveedora</span> ¬∑ Desarrollado por Lizandro Sustaita¬Æ
  </footer>

  <!-- L√≥gica de datos y Excel -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collectionGroup, getDocs, query, orderBy } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // ==== Config Firebase ====
    const firebaseConfig = {
      apiKey: "AIzaSyCK5nb6u2CGRJ8AB1aPlRn54b97bdeAFeM",
      authDomain: "inventariopv-643f1.firebaseapp.com",
      projectId: "inventariopv-643f1",
      storageBucket: "inventariopv-643f1.appspot.com",
      messagingSenderId: "96242533231",
      appId: "1:96242533231:web:aae75a18fbaf9840529e9a"
    };
    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    // ==== Utils ====
    const roundTo = (n,d)=> Math.round((Number(n)||0)*10**d)/10**d;
    const fmt = (n,d)=> Number(n||0).toFixed(d);
    const cap = s => String(s||'').charAt(0).toUpperCase() + String(s||'').slice(1);
    const toIso = v => { try{ if(v?.toDate) return v.toDate().toISOString(); }catch{} return typeof v==='string'?v:null; };

    // ==== DOM ====
    const selUsuario    = document.getElementById('sel-usuario');
    const btnBuscar     = document.getElementById('btn-buscar');
       const btnConcentrar = document.getElementById('btn-concentrar');
    const estado        = document.getElementById('estado');
    const grid          = document.getElementById('grid');
    const wmImg         = document.getElementById('wm-img');

    /** @type {{usuario:string, folio:string, fechaIso:string|null, articulos:any[]}[]} */
    let inventarios = [];

    // 1) Marca de agua: intenta rutas comunes y muestra solo cuando cargue
    (async function setWatermark(){
      const base = location.pathname.replace(/\/[^\/]*$/, ''); // carpeta actual
      const CANDIDATES = [
        'logo-proveedora.webp',
        './logo-proveedora.webp',
        base + '/logo-proveedora.webp',
        '/MONITOREO-INVENTARIOS-ANUALES/logo-proveedora.webp',
        '/logo-proveedora.webp',
        'assets/logo-proveedora.webp',
        'img/logo-proveedora.webp',
        'images/logo-proveedora.webp',
        'logo_proveedora.webp',
        'logo-proveedora.png',
        'img/logo-proveedora.png'
      ];
      for (const path of CANDIDATES){
        try {
          await new Promise((res, rej)=>{
            const t = new Image();
            t.onload = res;
            t.onerror = rej;
            t.src = path;
          });
          wmImg.src = path;
          wmImg.classList.add('show'); // ahora s√≠ se ve
          return;
        } catch {}
      }
      console.warn('Marca de agua: no se encontr√≥ el archivo. Revisa nombre y ruta en GitHub Pages.');
    })();

    // 2) Arranque vac√≠o
    render([]);

    // 3) Eventos UI
    selUsuario.addEventListener('change', ()=> render(filter()));
    btnBuscar.addEventListener('click', buscar);
    btnConcentrar.addEventListener('click', ()=>{
      const lista = filter();
      if(!lista.length){ alert('No hay inventarios para concentrar.'); return; }
      const items = concentrar(lista);
      const etiqueta = selUsuario.value==='todos' ? 'Todos' : cap(selUsuario.value);
      descargarExcelConcentrado(items, etiqueta);
    });

    // 4) Carga con fallback
    async function buscar(){
      try{
        setEstado('Buscando‚Ä¶');
        const q1 = query(collectionGroup(db,'escaneos'), orderBy('fecha','desc'));
        inventarios = await fetchDocs(q1);
        setEstado(`Listo: ${inventarios.length} inventario(s).`, 'ok');
      }catch(e){
        console.warn('Fallo orderBy(fecha). Reintentando sin √≠ndice‚Ä¶', e);
        try{
          const q2 = query(collectionGroup(db,'escaneos'));
          inventarios = await fetchDocs(q2);
          inventarios.sort((a,b)=> (b.fechaIso||'').localeCompare(a.fechaIso||'')); // ordenar en cliente
          setEstado(`Listo (sin √≠ndice): ${inventarios.length} inventario(s).`, 'ok');
        }catch(err){
          console.error(err);
          setEstado('Error leyendo Firestore. Revisa reglas/√≠ndices.', 'err');
          inventarios = [];
        }
      }
      render(filter());
    }

    async function fetchDocs(qry){
      const snap = await getDocs(qry);
      const out = [];
      snap.forEach(doc=>{
        const partes  = doc.ref.path.split('/');  // inventarios/<usuario>/escaneos/<id>
        const usuario = (partes.length>=2 ? partes[1] : (doc.data().usuario || 'desconocido')).toLowerCase();
        const d = doc.data();
        out.push({
          usuario,
          folio: d.folio || '(sin folio)',
          fechaIso: toIso(d.fecha),
          articulos: d.articulos || []
        });
      });
      return out;
    }

    function filter(){
      const f = selUsuario.value;
      return inventarios.filter(inv => f==='todos' ? true : inv.usuario===f);
    }

    function render(lista){
      const L = Array.isArray(lista)?lista:[];
      grid.innerHTML = '';
      if(!L.length){
        grid.innerHTML = `<p style="text-align:center">No hay inventarios para este filtro.</p>`;
        return;
      }
      for(const inv of L){
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
          <div class="titulo">${cap(inv.usuario)}</div>
          <div class="muted">Folio: <span class="pill">${inv.folio}</span></div>
          <div class="fila">
            <div class="muted">${inv.fechaIso ? inv.fechaIso.slice(0,16).replace('T',' ') : ''}</div>
            <div class="right"><button class="btn">‚¨áÔ∏è Excel</button></div>
          </div>
        `;
        card.querySelector('.btn').addEventListener('click', ()=> descargarExcelArticulos(inv.articulos, inv.folio));
        grid.appendChild(card);
      }
    }

    function setEstado(msg, kind){
      estado.className = kind==='ok' ? 'ok' : (kind==='err' ? 'err' : '');
      estado.textContent = msg || '';
    }

    // ===== Concentrado =====
    function concentrar(lista){
      const map = new Map(); // codigo => {codigo, descripcion, cantidad, precio}
      for(const inv of lista){
        for(const p of (inv.articulos||[])){
          const cod = String(p.codigo||'').trim();
          if(!cod) continue;
          const prev = map.get(cod) || { codigo: cod, descripcion: p.descripcion||'', cantidad: 0, precio: Number(p.precio||0) };
          prev.cantidad = Number(prev.cantidad||0) + Number(p.cantidad||0);
          if((p.descripcion||'').trim()) prev.descripcion = p.descripcion.trim();
          if(!isNaN(Number(p.precio))) prev.precio = Number(p.precio);
          map.set(cod, prev);
        }
      }
      return Array.from(map.values()).map(r=>({ ...r, total: roundTo(Number(r.cantidad||0)*Number(r.precio||0),2) }));
    }

    // ===== Excel: individual =====
    function descargarExcelArticulos(articulos, folio){
      const headers = [["#", "Descripci√≥n", "C√≥digo", "Cantidad", "Precio", "Total (Cant*Precio)", "Fecha", "Folio"]];
      const rows = (articulos||[]).map((p,i)=>{
        const cant = Number(p.cantidad||0);
        const precio = Number(p.precio||0);
        const tot = roundTo(cant*precio, 2);
        const ts = (p.timestamp||'').slice(0,19).replace('T',' ');
        return [i+1, p.descripcion||'', p.codigo||'', fmt(cant,3), fmt(precio,2), fmt(tot,2), ts, folio];
      });
      const suma = roundTo((articulos||[]).reduce((a,b)=> a + (Number(b.cantidad||0)*Number(b.precio||0)), 0), 2);
      rows.push([]); rows.push(["", "TOTAL INVENTARIO", "", "", "", fmt(suma,2), "", folio]);
      const wb = XLSX.utils.book_new(); const ws = XLSX.utils.aoa_to_sheet(headers.concat(rows));
      XLSX.utils.book_append_sheet(wb, ws, "Inventario");
      XLSX.writeFile(wb, `Inventario_${folio}.xlsx`);
    }

    // ===== Excel: concentrado =====
    function descargarExcelConcentrado(items, etiqueta){
      items.sort((a,b)=> String(a.descripcion||'').localeCompare(b.descripcion||'','es'));
      const headers = [["#", "C√≥digo", "Descripci√≥n", "Cantidad", "Precio", "Total (Cant*Precio)"]];
      const rows = items.map((r,i)=>[i+1, r.codigo, r.descripcion, fmt(r.cantidad,3), fmt(r.precio,2), fmt(r.total,2)]);
      const gTotal = roundTo(items.reduce((a,b)=> a + Number(b.total||0), 0), 2);
      rows.push([]); rows.push(["", "", "TOTAL GENERAL", "", "", fmt(gTotal,2)]);
      const wb = XLSX.utils.book_new(); const ws = XLSX.utils.aoa_to_sheet(headers.concat(rows));
      XLSX.utils.book_append_sheet(wb, ws, "Concentrado");
      XLSX.writeFile(wb, `Concentrado_${etiqueta}.xlsx`);
    }
  </script>
</body>
</html>
